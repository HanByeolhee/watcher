<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.watcher.mapper.ManagementMapper">

	<select id="getPopularityArticleList" resultType="map" parameterType="managementParam">
		SELECT
			DATE_FORMAT(A.REG_DATE_INQUIRY,'%Y%m%d') AS VISIT_DATE,
			COUNT(A.ID) AS CNT
		FROM (
				 SELECT
					 ID,REG_DATE_INQUIRY
				 FROM VISITOR_HISTORY
				 WHERE VISIT_STORY_MEM_ID IN(SELECT ID FROM MEMBER WHERE LOGIN_ID = #{search_login_id})
				   AND REG_MONTH_INQUIRY = DATE_FORMAT(NOW(),'%Y%m')
				 GROUP BY REG_DATE_INQUIRY, CLIENT_ID
			 ) A
	</select>

	<select id="getChartVisitorCntList" resultType="map" parameterType="managementParam">
		SELECT
			DATE_FORMAT(A.REG_DATE_INQUIRY,'%Y%m%d') AS VISIT_DATE,
			COUNT(A.ID) AS CNT
		FROM (
		    SELECT
				  ID,REG_DATE_INQUIRY
			  FROM VISITOR_HISTORY
			  WHERE VISIT_STORY_MEM_ID IN(SELECT ID FROM MEMBER WHERE LOGIN_ID = #{search_login_id})
				AND REG_MONTH_INQUIRY = DATE_FORMAT(NOW(),'%Y%m')
			  GROUP BY REG_DATE_INQUIRY, CLIENT_ID
		) A
	</select>

	<select id="getVisitorCnt" resultType="map" parameterType="managementParam">
		SELECT
			(
				SELECT COUNT(A.ID) FROM (
					SELECT
						ID,REG_DATE_INQUIRY
					FROM VISITOR_HISTORY
					WHERE VISIT_STORY_MEM_ID IN(SELECT ID FROM MEMBER WHERE LOGIN_ID = #{search_login_id})
					  AND REG_DATE_INQUIRY = DATE_FORMAT(NOW(),'%Y%m%d')
					GROUP BY REG_DATE_INQUIRY, CLIENT_ID
				) A
			) AS TODAY_VISIT_CNT,
			(
				SELECT COUNT(B.ID) FROM (
					SELECT
						ID,REG_DATE_INQUIRY
					FROM VISITOR_HISTORY
					WHERE VISIT_STORY_MEM_ID IN(SELECT ID FROM MEMBER WHERE LOGIN_ID = #{search_login_id})
					  AND REG_DATE_INQUIRY = date_format((DATE_ADD(now(), INTERVAL -1 DAY)),'%Y%m%d')
					GROUP BY REG_DATE_INQUIRY, CLIENT_ID
				) B
			) AS YESTERDAY_VISIT_CNT,
			(
				SELECT COUNT(C.ID) FROM (
					SELECT
						ID,REG_DATE_INQUIRY
					FROM VISITOR_HISTORY
					WHERE VISIT_STORY_MEM_ID IN(SELECT ID FROM MEMBER WHERE LOGIN_ID = #{search_login_id})
					GROUP BY REG_DATE_INQUIRY, CLIENT_ID
				) C
			) AS CUMULATIVE_VISIT_CNT,
			DATE_FORMAT(NOW(),'%Y-%m-%d %H:%i') AS VISIT_STATIS_CRITERIA
		FROM DUAL
	</select>

	<select id="getManagerSettings" resultType="map" parameterType="managementParam">
		SELECT
			  ID
			, REG_ID
			, DATE_FORMAT(REG_DATE,'%Y-%m-%d %H:%i') AS REG_DATE
            , UPT_ID
            , DATE_FORMAT(UPT_DATE,'%Y-%m-%d %H:%i') AS UPT_DATE
		    , LOGIN_ID
            , COMMENT_PERM_STATUS
		FROM MEM_MANAGEMENT
		WHERE LOGIN_ID = #{loginId}
	</select>

	<update id="updateManagement" parameterType="managementParam">
		UPDATE MEM_MANAGEMENT SET
		<if test="commentPermStatus != null and commentPermStatus != ''">
			COMMENT_PERM_STATUS 	= #{commentPermStatus} ,
		</if>
		UPT_ID 	= #{loginId} ,
		UPT_DATE 	= NOW()
		WHERE LOGIN_ID = #{loginId}
	</update>

	<insert id="insertManagement" parameterType="managementParam" useGeneratedKeys="true" keyColumn="loginId">
		INSERT INTO MEM_MANAGEMENT(
								   LOGIN_ID
								  ,REG_ID
								  ,REG_DATE
								  ,UPT_ID
								  ,UPT_DATE
								  ,COMMENT_PERM_STATUS
		)
		VALUES (
				   #{loginId}
			   ,#{loginId}
			   ,NOW()
			   ,#{loginId}
			   ,NOW()
			   ,'01'
			   )

		ON DUPLICATE KEY UPDATE
		<if test="commentPermStatus != null and commentPermStatus != ''">
			COMMENT_PERM_STATUS 	= #{commentPermStatus} ,
		</if>
		UPT_ID 	= #{loginId} ,
		UPT_DATE 	= NOW()
	</insert>


</mapper>